---
title: "Market Analysis"
author: "Curran Bhatia, Anupriya Tripathi, Krti Tallam, Nick Favale, Aaron Gilbert"
date: "4/4/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(stringr)
library(readr)
```

### Read in Data
```{r, echo=TRUE}

readInStocks = function(n) {
  # Gives n random stocks from the S & P 500
  # 
  # Args:
  #   n: Number of stocks to be read
  # 
  # Returns:
  #   List of dataframes with each stock's close value for each day
  
  snp = read_csv("Stocks.csv")
  
  nums = sample(1:500, n)
  arr100 = snp$Symbol[nums]
  sec100 = snp$Sector[nums]
  
  array = arr100
  
  
  stocks_2005 = list()
  
  for (i in 1:n) {
    
    dir = c("../Stocks/", as.character(array[i]), ".us.txt")
    
    dir2 = str_c(dir, collapse = "")
    print(dir2)
    if(!file.exists(dir2)) {
      next
    }
    stock = read.table(dir2, sep=",", header=TRUE)
    stock[3] <- NULL
    stock[3] <- NULL
    stock[4] <- NULL
    stock[4] <- NULL
    stock[2] <- NULL
  
    stock$name <- array[i]
    stocks_2005[[i]] <- stock
    
  }

  return(stocks_2005)

}


```


### Read Difference
```{r, echo=TRUE}

closeDiffPct = function(n, firstDate, secondDate, stocks_2005) {
  # Gives difference in close values from firstDate to secondDate
  # 
  # Args:
  #   n: Number of stocks to be read that are in stocks_2005
  #   firstDate: The first Date
  #   seconDate: The second Date
  #   stocks_2005: List of stock dataframes
  # 
  # Returns:
  #   A dataframe with the difference in percentage of close values, 
  #   with the stock name next to it
  
  
  rets = numeric(n)
  names = c()
  
  
  
  for (i in 1:n) {
     stock_df = stocks_2005[[i]]
     stock_df$Date = as.character(stock_df$Date)
     firstN = which(stock_df$Date == firstDate)
     secondN = which(stock_df$Date == secondDate)
     #print(firstN)
     #print(secondN)
     
     if ((is.integer(firstN) && length(firstN) == 0) | 
         (is.integer(secondN) && length(secondN) == 0)) {
       
       names = c("", names)
       next
     }
  
     stock_close_03 <- stock_df[firstN,]$Close 
     stock_close_04 <- stock_df[secondN,]$Close
     s_2005 <- (stock_close_04-stock_close_03)/stock_close_03
     
     #print(s_2005)
     rets[i] = s_2005
     names = c(stock_df$name[1], names)
  }
  
   return2005 = data.frame(rets, names)
   return2005
   
   return(return2005)
    
}


```


### Run Code
```{r}

set.seed(679)

#Run code
stocks = readInStocks(250)
readValues = closeDiffPct(250, "2005-03-01", "2005-06-01", stocks)
readValues
hist(readValues$rets)
mu = mean(readValues$rets)
var = var(readValues$rets)
mu
var
```

Prior distribution: $$g({\theta},{\sigma^2}) = Normal() * InverseGamma() $$
Likelihood function: $$L({\mu},{\sigma^2};x_1,...,x_n) = (2\pi{\sigma^2})^{-n/2}  exp({-1/{2\sigma^2}} \sum\limits_{j=1}^n (x_j - \mu)^2)$$
Posterior distribution: $$g(\theta,\sigma^2 | x_i) = L({\mu},{\sigma^2};x_1,...,x_n) * g({\theta},{\sigma^2})$$



###Graph Data
```{r}
hist(readValues$rets)
mean(readValues$rets)
var(readValues$rets)
```
###Prior
```{r}
theta <- 0
var1 <- 1
alpha <- 3
beta <- 1
g_prior = function(x, theta, var1, alpha, beta) {
  #return(dnorm(x, theta, var1)*dgamma(x, alpha, beta))
  #x <- seq(-1,1,.01)
  return(dnorm(x)*1)
}

#x <- rnorm(250)   # Must change to rnorm(500)
x <- seq(-1,1,.01)
hist(g_prior(x, theta, var1, alpha, beta))
gp = g_prior(x, theta, var1, alpha, beta)
plot(x,gp)
```


###Making a Posterior
```{r}
#IndexStart <- 1
#mu <- 0  # are these correct values??
#sigma2 <- 0  # are these correct values??
n <- 250
#x <- rnorm(250)
L = function(mu, sigma2, n, x){
  first = (2*pi*sigma2)^(-n/2)
  second = exp((-1/(2*sigma2))*sum((x - mu)^2))
  return(first*second)
}

rets = readValues$rets

gp = g_prior(x, theta, var1, alpha, beta)
theta2 = mean(rets) #1
var2 = var(rets) #1
posterior = L(theta2,var2, n, rets) * g_prior(x, theta, var1, alpha, beta)
plot(posterior)
mean(posterior)

c = L(theta2,var2,n,rets) * g_prior(rnorm(250),theta,var1,alpha,beta)
C = mean(c)
temp1 = (posterior/C)
hist(temp1)
temp = (posterior/C)*rnorm(250)
temp
plot(seq(-1,1, length.out = length(temp)),temp)
hist(temp)
plot(seq(-1,1, length.out = length(posterior)),posterior/C)

```
